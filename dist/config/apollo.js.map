{"version":3,"sources":["../../src/config/apollo.ts"],"sourcesContent":["import express from 'express';\r\nimport http from 'http';\r\nimport compression from 'compression';\r\nimport depthLimit from 'graphql-depth-limit';\r\nimport { ApolloServer } from 'apollo-server-express';\r\nimport { ApolloServerPluginDrainHttpServer } from 'apollo-server-core';\r\nimport { GraphQLSchema } from 'graphql';\r\nimport { graphqlUploadExpress } from 'graphql-upload';\r\nimport { context } from './context';\r\n\r\nconst port = process.env.PORT || 4000;\r\n\r\nconst uploadOptions = {\r\n  maxFileSize: 3 * 1024 * 1024, // no larger than 3mb, you can change as needed.\r\n  maxFiles: 5,\r\n};\r\n\r\nexport const startApolloServer = async (schema: GraphQLSchema) => {\r\n  const app = express();\r\n\r\n  const httpServer = http.createServer(app);\r\n\r\n  const server = new ApolloServer({\r\n    context,\r\n    schema,\r\n    plugins: [ApolloServerPluginDrainHttpServer({ httpServer })],\r\n    validationRules: [depthLimit(10)],\r\n    formatError: (error: any) => {\r\n      // don't expose internal server errors to the client ex: database errors\r\n      return error;\r\n    },\r\n  });\r\n\r\n  await server.start();\r\n\r\n  // attach middleware at this point to run before Apollo.\r\n  app.use(graphqlUploadExpress(uploadOptions));\r\n  app.use(compression());\r\n\r\n  server.applyMiddleware({ app });\r\n  await new Promise<void>((resolve) => httpServer.listen({ port }, resolve));\r\n\r\n  return {\r\n    url: `http://localhost:${port}${server.graphqlPath}`,\r\n    server,\r\n    app,\r\n  };\r\n};\r\n"],"names":["port","process","env","PORT","uploadOptions","maxFileSize","maxFiles","startApolloServer","schema","app","express","httpServer","http","createServer","server","ApolloServer","context","plugins","ApolloServerPluginDrainHttpServer","validationRules","depthLimit","formatError","error","start","use","graphqlUploadExpress","compression","applyMiddleware","Promise","resolve","listen","url","graphqlPath"],"mappings":"oGAAoB,KAAA,CAAS,WAAT,SAAS,GACZ,CAAM,WAAN,MAAM,GACC,CAAa,WAAb,aAAa,GACd,CAAqB,WAArB,qBAAqB,GACf,CAAuB,SAAvB,uBAAuB,EACF,CAAoB,SAApB,oBAAoB,EAEjC,CAAgB,SAAhB,gBAAgB,EAC7B,CAAW,SAAX,WAAW,CARN,oDAU7B,MAAMA,CAAI,CAAGC,OAAO,CAACC,GAAG,CAACC,IAAI,EAAI,GAAI,CAE/BC,CAAa,CAAG,CACpBC,WAAW,CAAE,OAAe,CAC5BC,QAAQ,CAAE,CAAC,CACZ,CAEYC,CAAiB,CAAG,MAAOC,CAAqB,EAAK,CAChE,IAAMC,CAAG,CAAGC,CAAO,QAAA,EAAE,CAEfC,CAAU,CAAGC,CAAI,QAAA,CAACC,YAAY,CAACJ,CAAG,CAAC,CAEnCK,CAAM,CAAG,IAAIC,CAAY,aAAA,CAAC,CAC9BC,OAAO,CAAPA,CAAO,QAAA,CACPR,MAAM,CAANA,CAAM,CACNS,OAAO,CAAE,CAACC,CAAiC,kCAAA,CAAC,CAAEP,UAAU,CAAVA,CAAU,CAAE,CAAC,CAAC,CAC5DQ,eAAe,CAAE,CAACC,CAAU,QAAA,CAAC,EAAE,CAAC,CAAC,CACjCC,WAAW,CAAE,AAACC,CAAU,EAEfA,CAAK,AACb,CACF,CAAC,AAboB,AAwBtB,QATA,MAAMR,CAAM,CAACS,KAAK,EAAE,CAGpBd,CAAG,CAACe,GAAG,CAACC,CAAoB,qBAAA,CAACrB,CAAa,CAAC,CAAC,CAC5CK,CAAG,CAACe,GAAG,CAACE,CAAW,QAAA,EAAE,CAAC,CAEtBZ,CAAM,CAACa,eAAe,CAAC,CAAElB,GAAG,CAAHA,CAAG,CAAE,CAAC,CAC/B,MAAM,IAAImB,OAAO,CAAO,AAACC,CAAO,EAAKlB,CAAU,CAACmB,MAAM,CAAC,CAAE9B,IAAI,CAAJA,CAAI,CAAE,CAAE6B,CAAO,CAAC,CAAC,CAEnE,CACLE,GAAG,CAAE,CAAC,iBAAiB,EAAE/B,CAAI,CAAC,EAAEc,CAAM,CAACkB,WAAW,CAAC,CAAC,CACpDlB,MAAM,CAANA,CAAM,CACNL,GAAG,CAAHA,CAAG,CACJ,AAAC,CACH,AArCqC,SAOzBF,iBAAiB,CAAjBA,CAAiB,AA8B5B"}